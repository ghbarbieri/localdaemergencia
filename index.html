<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Localização de emergência. Mostra rua, direção, velocidade, pontos de referência, coordenadas e Plus Code." />
  <meta name="theme-color" content="#0b1020" />
  <meta name="color-scheme" content="light dark" />
  <!-- CSP ajustada: permite script inline (emergência), e libera unpkg (OLC). -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src 'self' https://nominatim.openstreetmap.org https://overpass-api.de;
    img-src 'self' data:;
    script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
    base-uri 'none';
    form-action 'none';
  ">
  <title>Emergência • Localização</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%230ea5e9'/%3E%3Cpath d='M64 28a36 36 0 1036 36A36 36 0 0064 28Zm0 12a24 24 0 11-24 24A24 24 0 0164 40Z' fill='white'/%3E%3Ccircle cx='64' cy='64' r='6' fill='%230ea5e9'/%3E%3C/svg%3E" />

  <!-- Open Location Code (Plus Codes) — unpkg entrega MIME correto -->
  <script defer src="https://unpkg.com/open-location-code@1.0.4/dist/openlocationcode.js"></script>

  <style>
    :root { --bg:#0b1020; --fg:#e5f2ff; --primary:#0ea5e9; --muted:#8aa4b8; --card:#0f172a; --radius:14px; --shadow:0 8px 30px rgba(2,6,23,.18); --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    body.light-theme { --bg:#ffffff; --fg:#020617; --primary:#0284c7; --muted:#475569; --card:#f8fafc; --shadow:0 8px 30px rgba(51,65,85,.1); }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font: 400 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica Neue,Arial; color:var(--fg); background:var(--bg); transition: background-color .3s, color .3s; }
    main { display:flex; flex-direction:column; justify-content:center; text-align:center; padding:16px; gap:16px; min-height:100%; }
    #status-bar { padding:6px; font-size:14px; font-weight:700; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.2); position:fixed; top:0; left:0; right:0; z-index:100; }
    .status-ok{background:var(--ok)} .status-warn{background:var(--warn)} .status-err{background:var(--err)}
    .card{ background:var(--card); border-radius:var(--radius); padding:16px; text-align:center; margin-top:50px; }
    .primary-info h1{ margin:0; font-size:clamp(2.2rem,10vw,4rem); line-height:1.1; font-weight:800; color:var(--primary); }
    .primary-info .sub-heading{ font-size:clamp(1.1rem,5vw,1.8rem); font-weight:700; color:var(--fg); margin-top:.5rem; }
    .primary-info .context{ font-size:clamp(1rem,4vw,1.2rem); color:var(--muted); margin-top:.5rem; }
    .loading-text{ opacity:.6; font-style:italic; }
    .poi-card h2{ margin:0 0 12px 0; font-size:1.2rem; }
    .poi-list{ display:grid; gap:10px; text-align:left; }
    .poi-item{ border-left:3px solid var(--primary); padding-left:10px; }
    .poi-item .name{ font-weight:700 } .poi-item .meta{ font-size:.9rem; color:var(--muted) } .poi-item .meta.err{ color:var(--err) }
    .secondary-info{ margin-bottom:20px } .secondary-info .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:12px; text-align:left; }
    .label{ font-size:.8rem; color:var(--muted); font-weight:600 } .value{ font-weight:700; word-break:break-word }
    .actions{ margin-top:16px; display:grid; gap:10px } .dial-actions{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
    button,.btn{ display:block; cursor:pointer; font-weight:600; background:linear-gradient(180deg,color-mix(in oklab,var(--primary),#fff 10%),var(--primary)); color:#fff; border:0; border-radius:12px; padding:12px 18px; box-shadow:var(--shadow); min-height:44px }
    .btn-dial{ background:var(--muted); font-size:.9rem; padding:10px } .btn-cpr{ background:var(--warn) } .btn-alt{ background:#334155 }
    a{ color:inherit; text-decoration:none } a:focus-visible,button:focus-visible{ outline:3px solid color-mix(in oklab,var(--primary),#fff 25%); outline-offset:2px; border-radius:10px }
    .row{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)) }
    .muted{ color:var(--muted) }
    .note{ font-size:.9rem; color:var(--muted); text-align:left; margin-top:4px }
    .toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transition:opacity .2s,transform .2s; pointer-events:none; z-index:999 }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }
  </style>
</head>
<body>
  <div id="status-bar" class="status-warn" role="status" aria-live="polite">Buscando sinal de GPS...</div>
  <main>
    <div class="card primary-info" aria-labelledby="address">
      <h1 id="address">--</h1>
      <div id="direction-speed" class="sub-heading">-- km/h</div>
      <div id="city-info" class="context">--</div>
    </div>

    <div class="card poi-card" aria-labelledby="poi-title">
      <h2 id="poi-title">Pontos de Referência Próximos</h2>
      <div id="pois" class="poi-list">
        <div class="poi-item"><div class="meta">Aguardando localização precisa...</div></div>
      </div>
    </div>

    <div class="card secondary-info">
      <div class="grid">
        <div class="data-point"><div class="label">COORDENADAS</div><div id="coords" class="value">--</div></div>
        <div class="data-point"><div class="label">PLUS CODE</div><div id="pluscode" class="value">--</div></div>
        <div class="data-point"><div class="label">PRECISÃO</div><div id="accuracy" class="value">-- m</div></div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="copyCoords" class="btn-alt">Copiar Coordenadas</button>
        <a id="mapsLink" class="btn-alt" target="_blank" rel="noopener" href="#">Abrir no Google Maps</a>
      </div>

      <div class="actions">
        <div class="label">LIGAR PARA EMERGÊNCIA:</div>
        <div class="dial-actions" role="group" aria-label="Números de emergência">
          <a href="tel:190" class="btn btn-dial">190 (Polícia)</a>
          <a href="tel:192" class="btn btn-dial">192 (SAMU)</a>
          <a href="tel:193" class="btn btn-dial">193 (Bombeiros)</a>
        </div>

        <!-- Aviso informativo (toggle oculto; opt-out interno) -->
        <p class="note">
          Este app usa dados de rede por padrão para mostrar o endereço e locais próximos (OpenStreetMap/Nominatim/Overpass).
          Você só precisa permitir o acesso à localização do celular. <span class="muted">(É possível desativar internamente.)</span>
        </p>

        <div class="row">
          <button id="shareAll">Compartilhar Localização</button>
          <button id="cprBeepBtn" class="btn-cpr">Iniciar Beep para RCP</button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Copiado!</div>

<script>
  // ========= CONFIG =========
  const $ = (s) => document.querySelector(s);
  const CONTACT_EMAIL = ""; // opcional
  const UI_UPDATE_INTERVAL_MS = 2000;
  const API_MIN_DISTANCE_M = 25;
  const NOMINATIM_TTL_MS = 5 * 60 * 1000;
  const POI_TTL_MS       = 5 * 60 * 1000;
  const CPR_BPM          = 110;
  const CONSENT_KEY      = "emergencia:enrichConsent"; // "1" = ON, "0" = OFF (sem UI)

  // ========= UTIL =========
  const toRad = (deg)=>deg*Math.PI/180, toDeg = (rad)=>rad*180/Math.PI;
  const bearing=(lat1,lon1,lat2,lon2)=>{
    const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
    const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
    return (toDeg(Math.atan2(y,x))+360)%360;
  };
  const dirFromBearing=(b)=>['Norte','Nordeste','Leste','Sudeste','Sul','Sudoeste','Oeste','Noroeste'][Math.round(b/45)%8];
  const haversine=(lat1,lon1,lat2,lon2)=>{
    const R=6371e3, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  };
  const tileKey = (lat, lon) => `${lat.toFixed(3)},${lon.toFixed(3)}`;
  const showToast = (msg="Copiado!")=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1600); };
  const qs = (obj)=>Object.entries(obj).filter(([,v])=>v!==undefined && v!=='').map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');

  // ========= STATE =========
  let lastFix=null, prevFix=null, lastApiCallCoords={lat:0,lon:0}, isOnline=true;

  // ========= THEME/NET =====
  function applyTheme(){ const mq=window.matchMedia('(prefers-color-scheme: light)'); const sync=()=>document.body.classList.toggle('light-theme', mq.matches); mq.addEventListener?.('change', sync); sync(); }
  function setupOnlineDetection(){
    const update=()=>{ isOnline = navigator.onLine; if(!isOnline) updateStatusBar("Você está offline. Mostrando apenas dados locais.","warn"); };
    addEventListener('online',update); addEventListener('offline',update); update();
  }
  function updateStatusBar(text,status){ const bar=$('#status-bar'); bar.textContent=text; bar.className=`status-${status}`; }

  // ======== CONSENT (sem UI) ========
  function readQueryFlags(){
    const p=new URLSearchParams(location.search);
    if(p.has('optout')) localStorage.setItem(CONSENT_KEY,'0');
    if(p.has('optin'))  localStorage.setItem(CONSENT_KEY,'1');
  }
  function consentEnabled(){
    const v=localStorage.getItem(CONSENT_KEY);
    return v === null ? true : v === '1'; // default ON
  }

  // ========= GEO =========
  function deriveBearing(){
    if(!prevFix || !lastFix) return NaN;
    const v = lastFix.coords.speed ?? 0;
    if (v < 1.5) return NaN;
    return bearing(prevFix.coords.latitude, prevFix.coords.longitude, lastFix.coords.latitude, lastFix.coords.longitude);
  }
  function plusCodeFor(lat, lon, accuracy){
    try{
      if (window.OpenLocationCode && typeof window.OpenLocationCode.encode === 'function') {
        const len = accuracy > 100 ? 8 : accuracy > 30 ? 10 : 11;
        return window.OpenLocationCode.encode(lat, lon, len);
      }
    }catch(_){}
    return null;
  }

  // ========= CACHE =========
  const cacheGet=(ns,key)=>{ try{ const raw=localStorage.getItem(`${ns}:${key}`); if(!raw) return null; const obj=JSON.parse(raw); if(Date.now()>obj.exp){ localStorage.removeItem(`${ns}:${key}`); return null;} return obj.val; }catch{return null;} };
  const cacheSet=(ns,key,val,ttl)=>{ try{ localStorage.setItem(`${ns}:${key}`, JSON.stringify({val,exp:Date.now()+ttl})); }catch{} };

  // ========= START =========
  addEventListener('load',()=>{
    applyTheme(); setupOnlineDetection(); readQueryFlags();

    if (!('geolocation' in navigator)) { updateStatusBar('Geolocalização não suportada','err'); return; }

    navigator.geolocation.watchPosition(
      (pos)=>{ prevFix=lastFix; lastFix=pos; },
      (err)=>{ updateStatusBar(`Erro no GPS: ${err.message}`,'err'); },
      { enableHighAccuracy:true, timeout:15000, maximumAge:5000 }
    );

    setInterval(updateUI, UI_UPDATE_INTERVAL_MS);
    updateUI();
  });

  // ========= UI LOOP =========
  async function updateUI(){
    if(!lastFix) return;
    const { latitude, longitude, accuracy, heading, speed } = lastFix.coords;

    if (isOnline) {
      if (accuracy > 100) updateStatusBar(`Buscando GPS preciso... (atual: ${Math.round(accuracy)}m)`, 'warn');
      else updateStatusBar('Sinal de GPS bom', 'ok');
    }

    const br = Number.isFinite(heading) ? heading : deriveBearing();
    const dirText = Number.isFinite(br) ? `Sentido ${dirFromBearing(br)}` : 'Calculando direção';
    const spd = speed ? Math.round(speed*3.6) : 0;

    const dirSpd = `${dirText} a ${spd} km/h`;
    if ($('#direction-speed').textContent !== dirSpd) $('#direction-speed').textContent = dirSpd;

    const coordsTxt = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
    if ($('#coords').textContent !== coordsTxt) $('#coords').textContent = coordsTxt;

    const accTxt = `${Math.round(accuracy)} m`;
    if ($('#accuracy').textContent !== accTxt) $('#accuracy').textContent = accTxt;

    const pc = plusCodeFor(latitude, longitude, accuracy);
    $('#pluscode').textContent = pc || 'Indisponível';

    const mapsHref = `https://maps.google.com/?q=${latitude},${longitude}`;
    const linkEl = $('#mapsLink'); if (linkEl.getAttribute('href') !== mapsHref) linkEl.setAttribute('href', mapsHref);

    await updateEnrichedData();
  }

  async function updateEnrichedData(force=false){
    if (!consentEnabled() || !lastFix || !isOnline) return;
    const { latitude, longitude, accuracy } = lastFix.coords;
    const moved = haversine(lastApiCallCoords.lat, lastApiCallCoords.lon, latitude, longitude);
    if (!force && moved < API_MIN_DISTANCE_M && lastApiCallCoords.lat !== 0) return;

    lastApiCallCoords = { lat: latitude, lon: longitude };
    $('#address').classList.add('loading-text');
    $('#pois').replaceChildren(makeMeta('Atualizando…','loading-text'));

    await Promise.all([ enrichLocationData(latitude, longitude), enrichPOIs(latitude, longitude, accuracy) ]);
    $('#address').classList.remove('loading-text');
  }

  // ========= HTTP OSM =========
  const withTimeout = (fn, ms=10000, extSignal)=>{
    const ctrl = new AbortController(); const id=setTimeout(()=>ctrl.abort(), ms);
    const signal = extSignal ? anySignal([ctrl.signal, extSignal]) : ctrl.signal;
    return fn(signal).finally(()=>clearTimeout(id));
  };
  function anySignal(signals){ const ctrl=new AbortController(); const onAbort=()=>ctrl.abort(); signals.forEach(s=>s.addEventListener('abort',onAbort)); return ctrl.signal; }

  async function enrichLocationData(lat, lon){
    const addressEl=$('#address'), cityEl=$('#city-info');
    try{
      const key=tileKey(lat,lon), cached=cacheGet('nominatim',key);
      if(cached){ applyNominatim(cached,addressEl,cityEl); return; }
      const params={ format:'jsonv2', lat, lon, 'accept-language':'pt-BR', email: CONTACT_EMAIL || undefined, addressdetails:1 };
      const url=`https://nominatim.openstreetmap.org/reverse?${qs(params)}`;
      const res = await withTimeout((signal)=>fetch(url,{signal,headers:{Accept:'application/json'}}), 10000);
      if(!res.ok) throw new Error(`Nominatim HTTP ${res.status}`);
      const data=await res.json();
      cacheSet('nominatim',key,data,NOMINATIM_TTL_MS);
      applyNominatim(data,addressEl,cityEl);
    }catch(e){
      console.warn('Geocode Error:',e);
      addressEl.textContent="Endereço indisponível";
    }
  }
  function applyNominatim(data,addressEl,cityEl){
    const a=data.address||{};
    let t="Localização indisponível";
    if(a.road){
      t=a.road;
      if(a.house_number){ t+=`, ${a.house_number}`; }
      else {
        const parts=(data.display_name||"").split(',').map(s=>s.trim()).filter(Boolean);
        if(parts.length>1 && !parts[1].includes(a.road)) t+=` (próximo a ${parts[1]})`;
      }
    }else{
      t=(data.name && typeof data.name==='string')? data.name : (data.display_name?.split(',')[0] || "Via sem nome");
    }
    addressEl.textContent=t;
    const cityText=[a.suburb, a.neighbourhood, a.city||a.town||a.village, a.state].filter(Boolean).join(', ');
    cityEl.textContent=cityText||'--';
  }

  const poiTypeMap={ hospital:'Hospital', police:'Delegacia', fire_station:'Bombeiros', pharmacy:'Farmácia', fuel:'Posto', supermarket:'Supermercado', convenience:'Conveniência', clinic:'Clínica', doctors:'Consultório' };

  async function enrichPOIs(lat,lon,accuracy=50){
    const poisEl=$('#pois');
    try{
      const key=tileKey(lat,lon), cached=cacheGet('pois',key);
      if(cached){ renderPOIs(cached,lat,lon,poisEl); return; }
      const radius=Math.min(Math.max(accuracy*6,400),1000);
      const query=`[out:json][timeout:10];
        (
          node["amenity"~"hospital|police|fire_station|pharmacy|fuel|clinic|doctors"](around:${radius},${lat},${lon});
          way["amenity"~"hospital|police|fire_station|pharmacy|fuel|clinic|doctors"](around:${radius},${lat},${lon});
          node["shop"~"supermarket|convenience"](around:${radius},${lat},${lon});
          way["shop"~"supermarket|convenience"](around:${radius},${lat},${lon});
        ); out body center;`;
      const res = await withTimeout((signal)=>fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:query,signal,headers:{Accept:'application/json'}}), 10000);
      if(!res.ok) throw new Error(`Overpass HTTP ${res.status}`);
      const j=await res.json();
      cacheSet('pois',key,j,POI_TTL_MS);
      renderPOIs(j,lat,lon,poisEl);
    }catch(e){
      console.warn('POI Error:',e);
      poisEl.replaceChildren(makeMeta(e.name==='AbortError'?'A busca por referências demorou demais.':'Não foi possível carregar os pontos de referência.','err'));
    }
  }
  function renderPOIs(j,lat,lon,container){
    const els=Array.isArray(j.elements)?j.elements:[];
    const seen=new Set();
    const items=els.map(e=>{
      const la=e.lat ?? e.center?.lat, lo=e.lon ?? e.center?.lon;
      if(typeof la!=='number'||typeof lo!=='number') return null;
      const tk=e.tags?.amenity || e.tags?.shop || 'poi';
      const type=poiTypeMap[tk] || 'Ponto de Referência';
      const name=e.tags?.name || 'Não especificado';
      const dist=Math.round(haversine(lat,lon,la,lo));
      const dir =dirFromBearing(bearing(lat,lon,la,lo));
      const addr=e.tags?.['addr:street'] || '';
      return {type,name,dist,dir,addr};
    }).filter(Boolean).sort((a,b)=>a.dist-b.dist);

    const list=[];
    for(const it of items){
      const k=(it.type+'|'+it.name).toLowerCase();
      if(seen.has(k)) continue; seen.add(k); list.push(it);
      if(list.length>=6) break;
    }
    if(list.length===0){ container.replaceChildren(makeMeta('Nenhum ponto de referência encontrado nas proximidades.')); return; }

    container.replaceChildren(...list.map(it=>{
      const wrap=document.createElement('div'); wrap.className='poi-item';
      const n=document.createElement('div'); n.className='name'; n.textContent=`${it.type}: ${it.name}`;
      const m=document.createElement('div'); m.className='meta'; m.textContent=`Aprox. ${it.dist} m, direção ${it.dir}`;
      wrap.appendChild(n); wrap.appendChild(m);
      if(it.addr){ const m2=document.createElement('div'); m2.className='meta'; m2.textContent=it.addr; wrap.appendChild(m2); }
      return wrap;
    }));
  }
  function makeMeta(text,extra=''){ const d=document.createElement('div'); d.className='poi-item'; const m=document.createElement('div'); m.className='meta'+(extra?` ${extra}`:''); m.textContent=text; d.appendChild(m); return d; }

  // ========= AÇÕES =========
  function buildSharePayload(){
    const a=$('#address').textContent, c=$('#city-info').textContent, ds=$('#direction-speed').textContent;
    const coords=$('#coords').textContent, plus=$('#pluscode').textContent, acc=$('#accuracy').textContent;
    let poi=''; const items=[...document.querySelectorAll('.poi-item')];
    if(items.length>0 && !items[0].textContent.includes('...')){
      poi='\n*Referências Próximas:*\n'+items.map(el=>`- ${el.textContent.replace(/\s+/g,' ').trim()}`).join('\n');
    }
    return `*Localização de Emergência*\nEstou em: ${a}\n(${c})\n${ds}${poi}\n\nCoordenadas: ${coords}\nPlus Code: ${plus}\n(Precisão de ${acc})`.trim();
  }
  $('#shareAll')?.addEventListener('click', async ()=>{
    const payload=buildSharePayload();
    if(navigator.share){ try{ await navigator.share({title:'Minha Localização de Emergência', text:payload}); return; }catch(e){ console.warn('Web Share API',e); } }
    try{ await navigator.clipboard.writeText(payload); showToast('Informações copiadas!'); open(`https://wa.me/?text=${encodeURIComponent(payload)}`,'_blank','noopener'); }catch{ alert("Copie e envie:\n\n"+payload); }
  });
  $('#copyCoords')?.addEventListener('click', async ()=>{
    if(!lastFix) return; const {latitude,longitude}=lastFix.coords;
    const text=`${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
    try{ await navigator.clipboard.writeText(text); showToast('Coordenadas copiadas!'); }catch{ alert(text); }
  });

  // ========= RCP =========
  let audioCtx, cprInterval=null;
  $('#cprBeepBtn').addEventListener('click', async ()=>{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} }
    if(cprInterval){ clearInterval(cprInterval); cprInterval=null; $('#cprBeepBtn').textContent='Iniciar Beep para RCP'; }
    else{
      const beep=()=>{ const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination); osc.type='sine'; osc.frequency.value=880; g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(1,audioCtx.currentTime+.01); osc.start(audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+.1); osc.stop(audioCtx.currentTime+.1); };
      beep();
      cprInterval=setInterval(beep, 60000/CPR_BPM);
      $('#cprBeepBtn').textContent='Parar Beep';
    }
  });

  // ========= FIN =========
  (function initMapsLinkOnFirstFix(){
    const i=setInterval(()=>{ if(lastFix){ const {latitude,longitude}=lastFix.coords; $('#mapsLink').setAttribute('href',`https://maps.google.com/?q=${latitude},${longitude}`); clearInterval(i);} }, 500);
  })();
</script>
</body>
</html>
